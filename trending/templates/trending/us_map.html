{% extends 'base.html' %}

{% block content %}
<!-- Leaflet.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

<!-- Leaflet.js JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <h1>{{ template_data.title }}</h1>

      <!-- Map Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">US Movie Trends Map</h5>
        </div>
        <div class="card-body">
          <div id="map" style="height: 500px; width: 100%;"></div>
          <div id="location-info" style="margin-top:10px;padding:10px;background:#f8f9fa;border-radius:5px;">
            <div id="location-display" style="font-size:14px;">Loading...</div>
          </div>
        </div>
      </div>

      <div class = "row mt-4">
        <div class = "col-md-4 mb-3">
          <div class = "card h-100">
            <div class = "card-header"> Your Recent Purchases</div>
            <div class = "card-body small">
              {% if template_data.recent_purchases and request.user.is_authenticated %}
                {% for rp in template_data.recent_purchases %}
                  <div class = "mb-2">
                    <strong> Order #{{ rp.order.id }}</strong> - {{ rp.order.date|date:'Y-m-d H:i' }} - ${{ rp.order.total }}
                    <ul class = "mb-1">
                      {% for it in rp.items %}
                        <li>{{ it.movie.name }} x {{ it.quantity }}<small class = "text-muted">(${% widthratio it.price 1 1 %})</small></li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endfor %}
              {% else %}
              <p class = "text-muted"> No recent purchases or not logged in </p>
              {% endif %}
            </div>
          </div>
        </div>

        <div class = "col-md-4 mb-3">
          <div class = "card h-100">
            <div class = "card-header"> Other Users' Recent Purchases</div>
            <div class = "card-body small">
              {% if request.user.is_authenticated %}
              <form method = "get" id = "other-user-form">
                <input type = "hidden" name = "region" value = "{{template_data.selected_region}}">
                <div class = "mb-2">
                  <select name = "other_user" class = "form-select form-select-sm" onchange="document.getElementById('other-user-form').submit()">
                    <option value = ""> -- Select a user -- </option>
                    {% for u in template_data.other_users %}
                      <option value = "{{u.id}}" {% if template_data.selected_other_user and u.id == template_data.selected_other_user.id %}selected{% endif %}> {{ u.username }} </option>
                    {% endfor %}
                  </select>
                </div>

                {% if template_data.other_user_purchases %}
                  {% for op in template_data.other_user_purchases %}
                    <div class = "mb-2">
                      <strong>{{ op.order.user.username }}</strong> - Order # {{op.order.id}} - ${{op.order.total}}
                      <ul>
                        {% for it in op.items %}
                          <li>{{it.movie.name}} x {{it.quantity}}</li>
                        {% endfor %}
                      </ul>
                    </div>
                    {% endfor %}
                  {% else %}
                    <p class = "text-muted"> Select a user to view their recent purchases.</p>
                  {% endif %}
                </form>
                {% else %}
                  <p class = "text-muted"> Log in to view other users' recent purchases</p>
                {% endif %}
            </div>
          </div>
        </div>

        <div class = "col-md-4 mb-3">
          <div class = "card h-100">
            <div class = "card-header"> Region Trending Movies</div>
            <div class = "card-body small">
              <form method = "get" id = "region-form">
                {% if template_data.selected_other_user %}
                  <input type = "hidden" name = "other_user" value = "{{template_data.selected_other_user.id}}">
                {% endif %}
                <div class = "mb-2">
                  <select name = "region" class = "form-select form-select-sm" onchange="document.getElementById('region-form').submit()">
                    <option value = ""> -- Select region -- </option>
                    {% for rname in template_data.regions.keys %}
                      <option value = "{{ rname }}" {% if template_data.selected_region == rname %}selected{% endif %}> {{ rname }} </option>
                    {% endfor %}
                    </select>
                  </div>
                </form>

                {% if template_data.selected_region %}
                  <p class = "mb-2"><strong>{{template_data.selected_region}}</strong> - {{template_data.selected_region_state_count}} states</p>
                  {% if template_data.region_trending %}
                    <ol class = "mb-0">
                      {% for t in template_data.region_trending %}
                        <li>{{ t.movie.name }} <small class = "text-muted">({{t.count}} sold)</small></li>
                      {% endfor %}
                    </ol>
                  {% else %}
                    <p class = "text-muted"> There are no trending data for this region yet</p>
                  {% endif %}
                {% else %}
                    <p class = "text-muted"> Select a region to view trending movies</p>
                {% endif %}
            </div>
          </div>
        </div>

      </div>


      <!-- Region Cards -->
      <div class="row">
        {% for region_name, region_data in template_data.regions.items %}
        <div class="col-md-6 col-lg-3 mb-4">
          <div class="card h-100">
            <div class="card-header region-header" data-region-color="{{ region_data.color }}">
              <h6 class="mb-0">üó∫Ô∏è {{ region_name }}</h6>
            </div>
            <div class="card-body">
              {% for subregion_name, states in region_data.subregions.items %}
              <div class="mb-3">
                <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse"
                        data-bs-target="#{{ region_name|slugify }}-{{ subregion_name|slugify }}">
                  <h6 class="text-muted mb-1 d-flex justify-content-between align-items-center">
                    {{ subregion_name }}
                    <i class="fas fa-chevron-down" style="font-size:12px;"></i>
                  </h6>
                </button>
                <div class="collapse" id="{{ region_name|slugify }}-{{ subregion_name|slugify }}">
                  <ul class="list-unstyled small mt-2">
                    {% for state in states %}
                    <li>‚Ä¢ {{ state }}</li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- Setup Map ---
  const map = L.map('map').setView([39.8283, -98.5795], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  addRegionalMarkers(map);

  // --- Fetch and display user's orders ---
  fetch('/trending/api/orders/')
    .then(response => {
      if (response.status === 401 || response.status === 403) {
        console.warn("User not logged in, skipping order markers.");
        return [];
      }
      return response.json();
    })
    .then(data => {
      if (!Array.isArray(data)) return;

      const orderIcon = L.divIcon({
        className: 'order-marker',
        html: `<div style="background-color:#e74c3c;color:white;border-radius:50%;
                        width:22px;height:22px;display:flex;align-items:center;
                        justify-content:center;font-size:12px;">üé¨</div>`,
        iconSize: [22,22],
        iconAnchor: [11,11]
      });

      data.forEach(loc => {
        const marker = L.marker([loc.lat, loc.lng], { icon: orderIcon }).addTo(map);

        let orderListHTML = loc.orders
          .map(o => `<li>Total: $${o.total} ‚Äì ${o.date}</li>`)
          .join("");

        marker.bindPopup(`
          <b>You</b><br>
          ${loc.state}<br>
          <b>${loc.count} order${loc.count > 1 ? "s" : ""}</b> here:<br>
          <ul style="margin:6px 0;padding-left:16px;">${orderListHTML}</ul>
        `);
      });
    })
    .catch(err => console.error('Error loading order locations:', err));

  // --- Geolocation ---
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        map.setView([lat, lng], 6);
        L.circle([lat, lng], {
          color: 'blue', fillColor: 'blue', fillOpacity: 0.2, radius: 1000
        }).addTo(map);
        const marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`<b>Your Location</b><br>Lat: ${lat.toFixed(4)}<br>Lng: ${lng.toFixed(4)}`).openPopup();

        document.getElementById('location-display').innerHTML = `
          <strong>Your Location:</strong><br>
          Latitude: ${lat.toFixed(4)}<br>
          Longitude: ${lng.toFixed(4)}<br>
          <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank"
             class="btn btn-sm btn-outline-primary mt-1">View on Google Maps</a>`;
      },
      function() {
        const fallbackLat = 33.7756, fallbackLng = -84.3963;
        map.setView([fallbackLat, fallbackLng], 6);
        L.marker([fallbackLat, fallbackLng])
          .addTo(map)
          .bindPopup('<b>Default Location (Atlanta)</b>').openPopup();
        document.getElementById('location-display').innerHTML =
          '<span style="color:red;">Location access denied. Showing default location.</span>';
      }
    );
  } else {
    document.getElementById('location-display').innerHTML =
      '<span style="color:red;">Geolocation not supported.</span>';
  }
});

// --- Add Region Markers ---
function addRegionalMarkers(map) {
  const regions = [
    {
      name: 'Northeast', lat: 42.1657, lng: -74.9481, color: '#FF6B6B',
      states: ['Maine','New Hampshire','Vermont','Massachusetts','Rhode Island','Connecticut','New York','New Jersey','Pennsylvania']
    },
    {
      name: 'Midwest', lat: 41.8781, lng: -87.6298, color: '#4ECDC4',
      states: ['Ohio','Indiana','Illinois','Michigan','Wisconsin','Minnesota','Iowa','Missouri','North Dakota','South Dakota','Nebraska','Kansas']
    },
    {
      name: 'South', lat: 33.4484, lng: -86.7870, color: '#45B7D1',
      states: ['Delaware','Maryland','Virginia','West Virginia','North Carolina','South Carolina','Georgia','Florida','Kentucky','Tennessee','Mississippi','Alabama','Oklahoma','Texas','Arkansas','Louisiana']
    },
    {
      name: 'West', lat: 37.7749, lng: -122.4194, color: '#96CEB4',
      states: ['Montana','Idaho','Wyoming','Nevada','Utah','Colorado','Arizona','New Mexico','Alaska','Washington','Oregon','California','Hawaii']
    }
  ];

  regions.forEach(region => {
    const regionIcon = L.divIcon({
      className: 'region-marker',
      html: `<div style="background-color:${region.color};color:white;border-radius:50%;
                      width:30px;height:30px;display:flex;align-items:center;
                      justify-content:center;font-weight:bold;font-size:12px;
                      border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);">
                      ${region.name.charAt(0)}</div>`,
      iconSize: [30,30], iconAnchor: [15,15]
    });

    const marker = L.marker([region.lat, region.lng], { icon: regionIcon }).addTo(map);
    marker.bindPopup(`
      <div style="text-align:center;">
        <h6 style="color:${region.color};margin-bottom:10px;">üó∫Ô∏è ${region.name}</h6>
        <p style="font-size:12px;margin:0;">${region.states.length} states</p>
        <small style="color:#666;">Click to explore trending movies</small>
      </div>
    `);
  });
}

</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.region-header').forEach(function(el) {
    const color = el.getAttribute('data-region-color');
    if (color) {
      el.style.backgroundColor = color;
      el.style.color = 'white';
    }
  });
});

</script>
{% endblock %}

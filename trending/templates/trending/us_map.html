{% extends 'base.html' %}

{% block content %}
<!-- Leaflet.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

<!-- Leaflet.js JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>{{ template_data.title }}</h1>
            
            <!-- US Map -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">US Movie Trends Map</h5>
                </div>
                <div class="card-body">
                    <div id="map" style="height: 500px; width: 100%;"></div>
                    <div id="location-info" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div id="location-display" style="font-size: 14px;">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- US Regions Information -->
            <div class="row">
                {% for region_name, region_data in template_data.regions.items %}
                <div class="col-md-6 col-lg-3 mb-4">
                    <div class="card h-100">
                        <div class="card-header" style="background-color: {{ region_data.color }}; color: white;">
                            <h6 class="mb-0">üó∫Ô∏è {{ region_name }}</h6>
                        </div>
                        <div class="card-body">
                            {% for subregion_name, states in region_data.subregions.items %}
                            <div class="mb-3">
                                <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#{{ region_name|slugify }}-{{ subregion_name|slugify }}" aria-expanded="false" aria-controls="{{ region_name|slugify }}-{{ subregion_name|slugify }}">
                                    <h6 class="text-muted mb-1 d-flex justify-content-between align-items-center">
                                        {{ subregion_name }}
                                        <i class="fas fa-chevron-down" style="font-size: 12px;"></i>
                                    </h6>
                                </button>
                                <div class="collapse" id="{{ region_name|slugify }}-{{ subregion_name|slugify }}">
                                    <ul class="list-unstyled small mt-2">
                                        {% for state in states %}
                                        <li>‚Ä¢ {{ state }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Create map centered on US
    const map = L.map('map').setView([39.8283, -98.5795], 4);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Add regional markers
    addRegionalMarkers(map);
    
    // Request user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Center map on user location
                map.setView([lat, lng], 6);
                
                // Add blue circle around user location
                L.circle([lat, lng], {
                    color: 'blue',
                    fillColor: 'blue',
                    fillOpacity: 0.2,
                    radius: 1000
                }).addTo(map);
                
                // Add marker for user location
                const marker = L.marker([lat, lng]).addTo(map);
                marker.bindPopup('<b>Your Location</b><br>Lat: ' + lat.toFixed(4) + '<br>Lng: ' + lng.toFixed(4)).openPopup();
                
                // Update display
                document.getElementById('location-display').innerHTML = `
                    <strong>Your Location:</strong><br>
                    Latitude: ${lat.toFixed(4)}<br>
                    Longitude: ${lng.toFixed(4)}<br>
                    <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">View on Google Maps</a>
                `;
            },
            function(error) {
                // Fallback to Atlanta if location denied
                const fallbackLat = 33.7756;
                const fallbackLng = -84.3963;
                
                map.setView([fallbackLat, fallbackLng], 6);
                
                const marker = L.marker([fallbackLat, fallbackLng]).addTo(map);
                marker.bindPopup('<b>Default Location (Atlanta)</b><br>Lat: ' + fallbackLat + '<br>Lng: ' + fallbackLng).openPopup();
                
                document.getElementById('location-display').innerHTML = '<span style="color: red;">Location access denied. Showing default location.</span>';
            }
        );
    } else {
        document.getElementById('location-display').innerHTML = '<span style="color: red;">Geolocation not supported.</span>';
    }
});

function addRegionalMarkers(map) {
    // Regional center points and colors
    const regions = [
        {
            name: 'Northeast',
            lat: 42.1657,
            lng: -74.9481,
            color: '#FF6B6B',
            states: ['Maine', 'New Hampshire', 'Vermont', 'Massachusetts', 'Rhode Island', 'Connecticut', 'New York', 'New Jersey', 'Pennsylvania']
        },
        {
            name: 'Midwest',
            lat: 41.8781,
            lng: -87.6298,
            color: '#4ECDC4',
            states: ['Ohio', 'Indiana', 'Illinois', 'Michigan', 'Wisconsin', 'Minnesota', 'Iowa', 'Missouri', 'North Dakota', 'South Dakota', 'Nebraska', 'Kansas']
        },
        {
            name: 'South',
            lat: 33.4484,
            lng: -86.7870,
            color: '#45B7D1',
            states: ['Delaware', 'Maryland', 'Virginia', 'West Virginia', 'North Carolina', 'South Carolina', 'Georgia', 'Florida', 'Kentucky', 'Tennessee', 'Mississippi', 'Alabama', 'Oklahoma', 'Texas', 'Arkansas', 'Louisiana']
        },
        {
            name: 'West',
            lat: 37.7749,
            lng: -122.4194,
            color: '#96CEB4',
            states: ['Montana', 'Idaho', 'Wyoming', 'Nevada', 'Utah', 'Colorado', 'Arizona', 'New Mexico', 'Alaska', 'Washington', 'Oregon', 'California', 'Hawaii']
        }
    ];
    
    regions.forEach(region => {
        // Create custom icon for each region
        const regionIcon = L.divIcon({
            className: 'region-marker',
            html: `<div style="background-color: ${region.color}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${region.name.charAt(0)}</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        // Add marker to map
        const marker = L.marker([region.lat, region.lng], { icon: regionIcon }).addTo(map);
        
        // Add popup with region information
        marker.bindPopup(`
            <div style="text-align: center;">
                <h6 style="color: ${region.color}; margin-bottom: 10px;">üó∫Ô∏è ${region.name}</h6>
                <p style="font-size: 12px; margin: 0;">${region.states.length} states</p>
                <small style="color: #666;">Click to explore trending movies in this region</small>
            </div>
        `);
    });
}

// Handle dropdown chevron rotation
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners to all collapse buttons
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(button) {
        button.addEventListener('click', function() {
            const target = document.querySelector(this.getAttribute('data-bs-target'));
            const chevron = this.querySelector('.fas');
            
            // Toggle chevron rotation
            if (target.classList.contains('show')) {
                chevron.style.transform = 'rotate(0deg)';
            } else {
                chevron.style.transform = 'rotate(180deg)';
            }
        });
    });
});
</script>

{% endblock %}
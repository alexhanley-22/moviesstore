{% extends 'base.html' %}
{% block content %}
{% load static %}
{% load cart_filters %}

<div class="p-3">
  <div class="container">
    <div class="row mt-3">
      <div class="col mx-auto mb-3">
        <h2>Shopping Cart</h2>
        <hr />
      </div>
    </div>

    <div class="row m-1">
      {% if template_data.movies_in_cart %}
      <table class="table table-bordered table-striped text-center">
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col" class="text-start">Name</th>
            <th scope="col" class="text-end">Price</th>
            <th scope="col" class="text-center">Quantity</th>
          </tr>
        </thead>
        <tbody>
          {% for movie in template_data.movies_in_cart %}
          <tr>
            <td>{{ movie.id }}</td>
            <td class="text-start">{{ movie.name }}</td>
            <td class="text-end">${{ movie.price }}</td>
            <td class="text-center">
              {{ request.session.cart|get_quantity:movie.id }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-center mt-4">Your cart is empty.</p>
      {% endif %}
    </div>

    <div class="row">
      <div class="text-end">
        <a class="btn btn-outline-secondary mb-2">
          <b>Total to pay:</b> ${{ template_data.cart_total }}
        </a>

        {% if template_data.movies_in_cart|length > 0 %}
        <!-- ✅ Replaced link with POST form -->
        <form method="POST" action="{% url 'cart.purchase' %}" id="purchase-form" class="d-inline">
          {% csrf_token %}
          <!-- Hidden inputs to store user location -->
          <input type="hidden" id="latitude" name="latitude">
          <input type="hidden" id="longitude" name="longitude">
          <input type="hidden" id="state" name="state">

          <button type="submit" class="btn bg-dark text-white mb-2">Purchase</button>
        </form>

        <a href="{% url 'cart.clear' %}" class="btn btn-danger mb-2">
          Remove all movies from Cart
        </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ✅ JavaScript: Automatically capture geolocation -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('purchase-form');
  
    form.addEventListener('submit', (e) => {
      e.preventDefault(); // stop the default submit until we have coords
  
      // if geolocation is available
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            // fill hidden fields
            document.getElementById('latitude').value = pos.coords.latitude;
            document.getElementById('longitude').value = pos.coords.longitude;
  
            // reverse-geocode to find state name
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`)
              .then(r => r.json())
              .then(data => {
                const state = data.address.state || data.address.region || 'Unknown';
                document.getElementById('state').value = state;
                form.submit(); // ✅ now really submit
              })
              .catch(() => {
                document.getElementById('state').value = 'Unknown';
                form.submit();
              });
          },
          (err) => {
            alert('⚠️ Location access denied or failed — saving order without location.');
            document.getElementById('state').value = 'Unknown';
            form.submit(); // continue even if user blocks location
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      } else {
        alert('⚠️ Your browser does not support geolocation.');
        document.getElementById('state').value = 'Unknown';
        form.submit();
      }
    });
  });
  </script>
  

{% endblock content %}
